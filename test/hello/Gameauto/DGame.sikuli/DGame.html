
<html>
   <head>
      <style type="text/css">
         .sikuli-code {
            font-size: 20px;
            font-family: "Osaka-mono", Monospace;
            line-height: 1.5em;
            display:table-cell;
            white-space: pre-wrap;       /* css-3 */
            white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
            width: 99%;   /* remove horizontal scroll-bar when viewing in IE7 */
         }
         .sikuli-code img {
            vertical-align: middle;
            margin: 2px;
            border: 1px solid #ccc;
            padding: 2px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -moz-box-shadow: 1px 1px 1px gray;
            -webkit-box-shadow: 1px 1px 2px gray;
         }
         .kw {
            color: blue;
         }
         .skw {
            color: rgb(63, 127, 127);
         }

         .str {
            color: rgb(128, 0, 0);
         }

         .dig {
            color: rgb(128, 64, 0);
         }

         .cmt {
            color: rgb(200, 0, 200);
         }

         h2 {
            display: inline;
            font-weight: normal;
         }  
         
         .info {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 20px;
            display: none;
         }

         a {
            color: #9D2900;
         }

         body {
            font-family: "Trebuchet MS", Arial, Sans-Serif;
         }

      </style>
   </head>
<body>
<div class="info">
<h2>DGame.sikuli\DGame.sikuli</h2> <a href="DGame.sikuli\DGame.zip">(Download this script)</a>
</div>
<pre class="sikuli-code">
<span class="cmt"># -*- coding: utf-8 -*-
</span><span class="kw">from</span> sikuli <span class="kw">import</span> *
<span class="kw">import</span> urllib
<span class="kw">import</span> simplejson <span class="kw">as</span> json
<span class="kw">from</span> array <span class="kw">import</span> array
<span class="kw">import</span> logging
<span class="kw">import</span> logging.handlers

<span class="kw">import</span> email
<span class="kw">import</span> mimetypes
<span class="kw">from</span> email.MIMEMultipart <span class="kw">import</span> MIMEMultipart
<span class="kw">from</span> email.MIMEText <span class="kw">import</span> MIMEText
<span class="kw">from</span> email.MIMEImage <span class="kw">import</span> MIMEImage
<span class="kw">import</span> smtplib

<span class="cmt">#######  emai相关 开始 #########
</span><span class="kw">def</span> sendEmail(authInfo, fromAdd, toAdd, subject, plainText, htmlText):

        strFrom = fromAdd
        strTo = <span class="str">', '</span>.join(toAdd)

        server = authInfo.get(<span class="str">'server'</span>)
        user = authInfo.get(<span class="str">'user'</span>)
        passwd = authInfo.get(<span class="str">'password'</span>)

<span class="cmt"># 由于user和passwd可以不写，此校验暂时注掉  
</span><span class="cmt">#        if not (server and user and passwd) :  
</span><span class="cmt">#                print 'incomplete login info, exit now'  
</span><span class="cmt">#                return  
</span>
        <span class="cmt"># 设定root信息  
</span>        msgRoot = MIMEMultipart(<span class="str">'related'</span>)
        msgRoot[<span class="str">'Subject'</span>] = subject
        msgRoot[<span class="str">'From'</span>] = strFrom
        msgRoot[<span class="str">'To'</span>] = strTo
        msgRoot.preamble = <span class="str">'This is a multi-part message in MIME format.'</span>

        <span class="cmt"># Encapsulate the plain and HTML versions of the message body in an  
</span>        <span class="cmt"># 'alternative' part, so message agents can decide which they want to display.  
</span>        msgAlternative = MIMEMultipart(<span class="str">'alternative'</span>)
        msgRoot.attach(msgAlternative)

        <span class="cmt">#设定纯文本信息  
</span>        msgText = MIMEText(plainText, <span class="str">'plain'</span>, <span class="str">'utf-8'</span>)
        msgAlternative.attach(msgText)

        <span class="cmt">#设定HTML信息  
</span>        <span class="cmt">#msgText = MIMEText(htmlText, 'html', 'utf-8')  
</span>        <span class="cmt">#msgAlternative.attach(msgText)  
</span>
       <span class="cmt">#设定内置图片信息  
</span><span class="cmt">#        fp = open('test.jpg', 'rb')  
</span><span class="cmt">#        msgImage = MIMEImage(fp.read())  
</span><span class="cmt">#        fp.close()  
</span><span class="cmt">#        msgImage.add_header('Content-ID', '&lt;image1&gt;')  
</span><span class="cmt">#        msgRoot.attach(msgImage)  
</span>
       <span class="cmt">#发送邮件  
</span>        smtp = smtplib.SMTP()
       <span class="cmt">#设定调试级别，依情况而定  
</span>        smtp.set_debuglevel(<span class="dig">1</span>)
        smtp.connect(server)
        <span class="cmt">#smtp.login(user, passwd)   #此步可以干掉
</span>        <span class="cmt">#smtp.sendmail(strFrom, strTo, msgRoot.as_string())  #这句 貌似多收件人时 只有第一个收到--未确认
</span>        smtp.sendmail(strFrom, toAdd, msgRoot.as_string())  <span class="cmt">#多收件人这个ok</span>

        smtp.quit()
        <span class="kw">return</span>

authInfo = {}
authInfo[<span class="str">'server'</span>] = <span class="str">'mail1-in.baidu.com'</span>
authInfo[<span class="str">'user'</span>] = <span class="str">''</span>  <span class="cmt">#此值可以不写</span>
authInfo[<span class="str">'password'</span>] = <span class="str">''</span>  <span class="cmt">#此值可以不写</span>
fromAdd = <span class="str">'sikuli@baidu.com'</span>   <span class="cmt">#发件人 随便写</span>
toAdd = [<span class="str">'qixiuping@baidu.com'</span>,<span class="str">'zhujinling@baidu.com'</span>,<span class="str">'guolin02@baidu.com'</span>]  <span class="cmt">#收件人</span>
subject = <span class="str">'进游戏监控--异常通知'</span>  <span class="cmt">#邮件title</span>
htmlText = <span class="str">''</span>
<span class="cmt">#######  emai相关 结束 #########  
</span>

<span class="cmt">#######  log相关 开始 #########
</span>LOG_FILE = <span class="str">'tst.log'</span>
handler = logging.handlers.RotatingFileHandler(LOG_FILE, maxBytes = <span class="dig">1024</span>*<span class="dig">1024</span>, backupCount = <span class="dig">5</span>) <span class="cmt"># 实例化handler   </span>
fmt = <span class="str">'%(asctime)s - %(filename)s:%(lineno)s - %(name)s - %(message)s'</span>
formatter = logging.Formatter(fmt)   <span class="cmt"># 实例化formatter  </span>
handler.setFormatter(formatter)      <span class="cmt"># 为handler添加formatter    </span>
logger = logging.getLogger(<span class="str">'tst'</span>)    <span class="cmt"># 获取名为tst的logger  </span>
logger.addHandler(handler)           <span class="cmt"># 为logger添加handler  </span>
logger.setLevel(logging.DEBUG)
<span class="cmt">#######  log相关 结束 #########
</span>
<span class="cmt">#######  获取gameid+serverid 开始 #########
</span><span class="kw">def</span> getGameIdList():
    url_gameid = <span class="str">'http://wanba.baidu.com/godoubi.xhtml?c=loadgame'</span>
    page = urllib.urlopen(url_gameid)
    page_result_str = page.read()
    page_result_json = json.loads(page_result_str)
    gameId_list = []
    gameList = page_result_json[<span class="str">"gameList"</span>]  <span class="cmt">#得到gameList</span>

    letter_list = [<span class="str">"ABC"</span>,<span class="str">"DEFG"</span>,<span class="str">"HIJK"</span>,<span class="str">"LMNO"</span>,<span class="str">"TPQRS"</span>,<span class="str">"UVWX"</span>,<span class="str">"YZ"</span>]
    <span class="kw">for</span> letter <span class="kw">in</span> letter_list:
       gameList_letter = gameList[letter]
       <span class="kw">for</span> val <span class="kw">in</span> gameList_letter:   <span class="cmt">#得到gameid</span>
           gameid = val[<span class="str">"id"</span>]
           gameId_list.append(gameid)
    <span class="kw">return</span> gameId_list


<span class="kw">def</span> getServerIdList(gameid):
    url = <span class="str">'http://wanba.baidu.com/server_list_not_login.xhtml?c=gameList&amp;gid='</span>+gameid
    page = urllib.urlopen(url)
    page_result_str = page.read()
    page_result_json = json.loads(page_result_str)
    serverList =  page_result_json[<span class="str">"serverList"</span>]
    serverId_list = []
    <span class="kw">for</span> val <span class="kw">in</span> serverList:  <span class="cmt">#处理serverlist--只留serverid</span>
        status = val[<span class="str">"status"</span>]
        status_weihuzhong = <span class="str">"维护中"</span>.decode(<span class="str">'utf-8'</span>)
        status_huobaokaiqi = <span class="str">"火爆开启"</span>.decode(<span class="str">'utf-8'</span>)
        status_zhengchangkaiqi = <span class="str">"正常开启"</span>.decode(<span class="str">'utf-8'</span>)

        <span class="kw">if</span> status == status_huobaokaiqi <span class="kw">or</span> status == status_zhengchangkaiqi:
            list = val[<span class="str">"params"</span>].split(<span class="str">'='</span>)
            server_no = len(list)
            serverid = list[server_no-<span class="dig">1</span>]
            e = serverid.encode(<span class="str">'raw_unicode_escape'</span>)  <span class="cmt">#去掉u  </span>
            serverId_list.append(e)
        <span class="kw">if</span> len(serverId_list) ==<span class="dig">1</span>:
            <span class="kw">break</span>
    <span class="kw">return</span> serverId_list

<span class="kw">def</span> getDataDict():
    data_list = []
    gameId_list = getGameIdList()
    <span class="kw">for</span> gameid <span class="kw">in</span> gameId_list:
      serverId_list = getServerIdList(str(gameid))
      <span class="kw">for</span> serverid <span class="kw">in</span> serverId_list:
          data_dict = dict.fromkeys([<span class="str">'gameId'</span>,<span class="str">'serverId'</span>],<span class="dig">0</span>)
          data_dict[<span class="str">'gameId'</span>] = str(gameid)
          data_dict[<span class="str">'serverId'</span>] = serverid
          data_list.append(data_dict)
          <span class="kw">del</span> data_dict
    <span class="cmt">#print data_list
</span>    <span class="kw">return</span> data_list
<span class="cmt">#######  获取gameid+serverid 结束 #########
</span>
<span class="kw">global</span> data_dict
data_dict = getDataDict()      <span class="cmt">#gameId和serverId List</span>
<span class="kw">print</span> data_dict
time=len(data_dict)            <span class="cmt">#进游戏链接轮询次数</span>


<span class="cmt">#################游戏加载情况判断###################        
</span><span class="kw">def</span> gameLoad(gameUrl,img_role):
    window=<span class="dig">0</span>
    result=<span class="dig">1</span>
    <span class="kw">for</span> i <span class="kw">in</span> range (<span class="dig">0</span>,<span class="dig">2</span>):
        <span class="skw">type</span>(<span class="str">"t"</span>,KEY_CTRL)
        window=window+<span class="dig">1</span>
        <span class="skw">wait</span>(<span class="dig">1</span>)
        paste(gameUrl)
        <span class="skw">type</span>(Key.ENTER)
        <span class="kw">if</span>  exists(img_role,<span class="dig">20</span>):
            logger.info(<span class="str">"OK------------gameId: "</span>+gameId+<span class="str">"----serverId: "</span>+serverId+<span class="str">"-----"</span>)
            result=<span class="dig">1</span>
            <span class="kw">break</span>
        <span class="kw">else</span>:
            result=<span class="dig">0</span>
    <span class="kw">if</span> result==<span class="dig">0</span>:
        logger.info(<span class="str">"ERROR------------gameId: "</span>+gameId+<span class="str">"----serverId: "</span>+serverId+<span class="str">"-----"</span>)
        plainText = <span class="str">'进游戏异常链接:\n\n'</span> + gameUrl  <span class="cmt">#邮件内容</span>
        sendEmail(authInfo, fromAdd, toAdd, subject, plainText, htmlText) <span class="cmt">#发邮件</span>
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="dig">0</span>,window):
        <span class="skw">type</span>(<span class="str">"w"</span>,KEY_CTRL)
        <span class="kw">while</span> exists(<img src="1414581521671-2.png" />,<span class="dig">2</span>):
            <span class="skw">click</span>(<img src="1414581547450-2.png" />)
            <span class="skw">wait</span>(<span class="dig">1</span>)

<span class="cmt">###################主程序#####################################       
</span><span class="kw">if</span> __name__ == <span class="str">'__main__'</span>:
   <span class="kw">for</span> index <span class="kw">in</span> range (<span class="dig">0</span>,time):
        gameId = data_dict[index][<span class="str">'gameId'</span>]
        serverId = data_dict [index][<span class="str">'serverId'</span>]
        gameUrl=<span class="str">'http://wanba.baidu.com/login_game_for_general.xhtml?id='</span>+gameId+ <span class="str">'&amp;serverId='</span>+serverId   <span class="cmt"># 游戏页地址</span>
        img_role=<span class="str">"..\img\\"</span>+gameId+<img src=".png" />
        gameLoad(gameUrl,img_role)
    <span class="cmt">#type("w",KEY_CTRL)</span>
</pre>
</body>
</html>
